---
- name: Check Homebrew is installed
  stat: path=/usr/local/bin/brew
  register: brew_installed

- name: Install Homebrew
  shell: ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"
  when: brew_installed.stat.exists == false

- name: Remove outdated homebrew taps
  homebrew_tap: tap={{ item }} state=absent
  with_items:
    - phinze/cask

- name: Install homebrew taps
  homebrew_tap: tap={{ item }} state=present
  with_items:
    - caskroom/cask
    - caskroom/versions
    - homebrew/binary
    - homebrew/dupes
    - homebrew/versions
    - thoughtbot/formulae

- name: Install apps with brew-cask
  homebrew_cask: name={{ item }} state=installed
  with_items: applications
  ignore_errors: yes


- name: Install quicklook plugins with brew-cask (https://github.com/sindresorhus/quick-look-plugins)
  homebrew_cask: name={{ item }} state=installed
  with_items:
    - qlcolorcode
    - qlstephen
    - qlmarkdown
    - quicklook-json
    - qlprettypatch
    - quicklook-csv
    - betterzipql
    - qlimagesize
    - webpquicklook
    - suspicious-package

- name: Install 'homebrew' libraries
  homebrew: name={{ item }} state=present
  with_items: brews

- name: Cleanup 'homebrew'
  command: brew prune && brew cleanup && brew tap --repair

- name: Write launch agent config for updating homebrew automatically
  copy: src=homebrew.update.plist dest={{ home_dir }}/Library/LaunchAgents
        mode=0755

- name: Load launchagent config
  command: launchctl load {{ home_dir }}/Library/LaunchAgents/homebrew.update.plist

- name: Start homebrew update lauch agent
  command: launchctl start homebrew.update

- name: Cleanup dock
  command: dockutil --remove all
